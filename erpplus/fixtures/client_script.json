[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 1,
  "modified": "2023-11-19 17:35:04.944217",
  "module": "Erpplus",
  "name": "Statistics Family Filters",
  "script": "frappe.ui.form.on('Item', {\n\tsetup(frm) {\n\t\tfrm.set_query(\"statistics_family_1\", function() {\n\t\t\treturn {\n\t\t\t\t\"filters\": {\n\t\t\t\t\t\"level\": \"Level 1\"\n\t\t\t\t}\n\t\t\t};\n\t\t});\n\t\tfrm.set_query(\"statistics_family_2\", function() {\n\t\t\treturn {\n\t\t\t\t\"filters\": {\n\t\t\t\t\t\"level\": \"Level 2\"\n\t\t\t\t}\n\t\t\t};\n\t\t});\n\t}\n\t\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Invoice",
  "enabled": 1,
  "modified": "2023-12-11 19:23:52.465434",
  "module": "Erpplus",
  "name": "Payable Provision Dialog",
  "script": "frappe.ui.form.on('Purchase Invoice', {\r\n    refresh(frm) {\r\n        frm.add_custom_button(\r\n            __(\"Get Payable Provisions\"),\r\n            function () {\r\n                frappe.call({\r\n                    method: \"erpnext.accounts.doctype.accounting_dimension.accounting_dimension.get_dimensions\",\r\n                    args: { \"with_cost_center_and_project\": true },\r\n                    callback: function (r) {\r\n\r\n                        const currentDate = new Date();\r\n                        const firstDayOfYear = new Date(currentDate.getFullYear(), 0, 1);\r\n                        const lastDayOfYear = new Date(currentDate.getFullYear(), 11, 31);\r\n                        var fields_dict = [];\r\n                        var dimensions = [];\r\n                        var col1 = [\r\n                            {\r\n                                label: 'Start Date',\r\n                                fieldname: 'start_date',\r\n                                fieldtype: 'Date',\r\n                                default: firstDayOfYear,\r\n                                onchange: function () {\r\n                                    get_provisions();\r\n                                },\r\n                            },\r\n                        ];\r\n                        var col2 = [\r\n                            {\r\n                                label: 'End Date',\r\n                                fieldname: 'end_date',\r\n                                fieldtype: 'Date',\r\n                                default: lastDayOfYear,\r\n\t\t\t\t\t\t\t\tonchange: function () {\r\n                                    get_provisions();\r\n                                },\r\n                            },\r\n                        ];\r\n                        var col3 = [];\r\n\r\n                        r.message[0].forEach((e, index) => {\r\n                            if (index % 3 === 0) {\r\n                                if (e.fieldname != 'supplier')\r\n                                    col1.push({\r\n                                        label: e.document_type,\r\n                                        fieldname: e.fieldname,\r\n                                        fieldtype: 'Link',\r\n                                        options: e.document_type,\r\n\t\t\t\t\t\t\t\t\t\tonchange: function () {\r\n\t\t\t\t\t\t\t\t\t\t\tget_provisions();\r\n\t\t\t\t\t\t\t\t\t\t},\r\n                                    });\r\n                                else\r\n                                    col1.push({\r\n                                        label: e.document_type,\r\n                                        fieldname: e.fieldname,\r\n                                        fieldtype: 'Link',\r\n                                        options: e.document_type,\r\n                                        read_only: 1,\r\n                                        default: cur_frm.doc.supplier,\r\n\t\t\t\t\t\t\t\t\t\tonchange: function () {\r\n\t\t\t\t\t\t\t\t\t\t\tget_provisions();\r\n\t\t\t\t\t\t\t\t\t\t},\r\n                                    });\r\n                            };\r\n                            if (index % 3 === 1) {\r\n                                if (e.fieldname != 'supplier')\r\n                                    col2.push({\r\n                                        label: e.document_type,\r\n                                        fieldname: e.fieldname,\r\n                                        fieldtype: 'Link',\r\n                                        options: e.document_type,\r\n\t\t\t\t\t\t\t\t\t\tonchange: function () {\r\n\t\t\t\t\t\t\t\t\t\t\tget_provisions();\r\n\t\t\t\t\t\t\t\t\t\t},\r\n                                    });\r\n                                else\r\n                                    col2.push({\r\n                                        label: e.document_type,\r\n                                        fieldname: e.fieldname,\r\n                                        fieldtype: 'Link',\r\n                                        options: e.document_type,\r\n                                        read_only: 1,\r\n                                        default: cur_frm.doc.supplier,\r\n\t\t\t\t\t\t\t\t\t\tonchange: function () {\r\n\t\t\t\t\t\t\t\t\t\t\tget_provisions();\r\n\t\t\t\t\t\t\t\t\t\t},\r\n                                    });\r\n                            };\r\n                            if (index % 3 === 2) {\r\n                                if (e.fieldname != 'supplier')\r\n                                    col3.push({\r\n                                        label: e.document_type,\r\n                                        fieldname: e.fieldname,\r\n                                        fieldtype: 'Link',\r\n                                        options: e.document_type,\r\n\t\t\t\t\t\t\t\t\t\tonchange: function () {\r\n\t\t\t\t\t\t\t\t\t\t\tget_provisions();\r\n\t\t\t\t\t\t\t\t\t\t},\r\n                                    });\r\n                                else\r\n                                    col3.push({\r\n                                        label: e.document_type,\r\n                                        fieldname: e.fieldname,\r\n                                        fieldtype: 'Link',\r\n                                        options: e.document_type,\r\n                                        read_only: 1,\r\n                                        default: cur_frm.doc.supplier,\r\n\t\t\t\t\t\t\t\t\t\tonchange: function () {\r\n\t\t\t\t\t\t\t\t\t\t\tget_provisions();\r\n\t\t\t\t\t\t\t\t\t\t},\r\n                                    });\r\n                            };\r\n                        });\r\n\r\n                        col1.forEach(e => fields_dict.push(e));\r\n                        fields_dict.push({\r\n                            fieldname: \"column_break_01\",\r\n                            fieldtype: \"Column Break\"\r\n                        });\r\n\r\n                        col2.forEach(e => fields_dict.push(e));\r\n                        fields_dict.push({\r\n                            fieldname: \"column_break_02\",\r\n                            fieldtype: \"Column Break\"\r\n                        });\r\n\r\n                        col3.forEach(e => fields_dict.push(e));\r\n                        fields_dict.push({\r\n                            fieldname: \"section_break_01\",\r\n                            fieldtype: \"Section Break\"\r\n                        },);\r\n                        fields_dict.push({\r\n                            label: 'Provisions',\r\n                            fieldname: 'provision',\r\n                            fieldtype: 'Table',\r\n                            data: [],\r\n                            fields: [\r\n\t\t\t\t\t\t\t\t/*{\r\n                                    fieldname: 'select',\r\n                                    fieldtype: 'Check',\r\n                                    in_list_view: 1,\r\n                                },*/\r\n                                {\r\n                                    label: 'Account',\r\n                                    fieldname: 'account',\r\n                                    fieldtype: 'Link',\r\n                                    options: \"Account\",\r\n                                    in_list_view: 1,\r\n                                    read_only: 1,\r\n                                },\r\n                                {\r\n                                    label: 'Amount',\r\n                                    fieldname: 'amount',\r\n                                    fieldtype: 'Currency',\r\n                                    in_list_view: 1,\r\n                                    read_only: 1,\r\n                                },\r\n                                {\r\n                                    label: 'To be Paid',\r\n                                    fieldname: 'to_be_paid',\r\n                                    fieldtype: 'Currency',\r\n                                    in_list_view: 1,\r\n                                    read_only: 1,\r\n                                },\r\n\t\t\t\t\t\t\t\t{\r\n                                    label: 'Voucher',\r\n                                    fieldname: 'voucher_no',\r\n                                    fieldtype: 'Data',\r\n                                    in_list_view: 1,\r\n                                    read_only: 1,\r\n                                },\r\n\t\t\t\t\t\t\t\t{\r\n                                    label: 'GL Entry',\r\n                                    fieldname: 'gl_entry',\r\n                                    fieldtype: 'Link',\r\n                                    options: \"GL Entry\",\r\n                                    in_list_view: 1,\r\n                                    read_only: 1,\r\n                                },\r\n                            ],\r\n                        },);\r\n\r\n                        if (r.message) dimensions = r.message;\r\n                        console.log(r);\r\n                        let d = new frappe.ui.Dialog({\r\n                            title: 'Payable Provisions',\r\n                            fields: fields_dict,\r\n                            primary_action_label: __('Insert'),\r\n                            primary_action(values) {\r\n\t\t\t\t\t\t\t\tvalues.provision.forEach(x => {if (x.__checked) {\r\n\t\t\t\t\t\t\t\t\tvar row = frm.add_child('items');\r\n\t\t\t\t\t\t\t\t\trow.item_name = (x.voucher_no ? x.voucher_no : x.gl_entry) ;\r\n\t\t\t\t\t\t\t\t\trow.qty = 1;\r\n\t\t\t\t\t\t\t\t\trow.rate = x.to_be_paid;\r\n\t\t\t\t\t\t\t\t\trow.uom = \"Nos\";\r\n\t\t\t\t\t\t\t\t\trow.expense_account = x.account;\r\n\t\t\t\t\t\t\t\t\trow.gl_entry = x.gl_entry;\r\n\t\t\t\t\t\t\t\t}});\r\n\t\t\t\t\t\t\t\tcur_frm.refresh_field(\"items\");\r\n                            }\r\n                        });\r\n                        d.show();\r\n\t\t\t\t\t\tget_provisions();\r\n                    },\r\n                });\r\n            },\r\n        );\r\n\r\n        function get_provisions() {\r\n            const params = [];\r\n            console.log(cur_dialog);\r\n            Object.keys(cur_dialog.fields_dict).forEach((key) => {\r\n                // Skip processing for keys that include 'session' or 'column'\r\n                if (['section', 'column', 'undefined', 'provision'].some(substr => key.includes(substr))) {\r\n                    return;\r\n                }\r\n                const dict = cur_dialog.fields_dict[key];\r\n                const value = dict.value;\r\n                console.log(`${key}: ${dict}`);\r\n                params.push({ key, value });\r\n            });\r\n\r\n            frappe.call({\r\n                method: \"erpplus.utils.get_provisions_from_gl\",\r\n                args: { \"params\": params },\r\n                callback: function (r) {\r\n                    // Your callback logic here\r\n\t\t\t\t\tcur_dialog.fields_dict.provision.df.data.length = 0;\r\n\t\t\t\t\tr.message.forEach(d => {\r\n\t\t\t\t\t\tcur_dialog.fields_dict.provision.df.data.push({\r\n\t\t\t\t\t\t\taccount: d.account,\r\n\t\t\t\t\t\t\tamount: d.amount,\r\n\t\t\t\t\t\t\tto_be_paid: d.remaining_amount,\r\n\t\t\t\t\t\t\tgl_entry: d.name,\r\n\t\t\t\t\t\t\tvoucher_no: d.voucher_no\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t})\r\n\t\t\t\t\t//cur_dialog.fields_dict.provision.df.data\r\n\t\t\t\t\tcur_dialog.fields_dict.provision.refresh()\r\n                },\r\n            });\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 }
]